{% extends 'patients/base.html' %}

{% block content %}
<style>
    /* CSS for the Loading Spinner */
    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #005f73;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .loading-text { color: #666; font-style: italic; font-size: 0.9em; }
</style>

<div style="display: flex; gap: 2rem;">
    
    <div style="flex: 1;">
        <h3>Patient Record: {{ patient.full_name }}</h3>
        <p><strong>DOB:</strong> {{ patient.date_of_birth }}</p>
        <p><strong>Blood Type:</strong> {{ patient.blood_type }}</p>
        
        <div class="alert">
            <strong>Allergies:</strong> {{ patient.allergies }}
        </div>
        
        <h4>Existing Conditions</h4>
        <p>{{ patient.existing_conditions }}</p>
        <hr>

        <hr>
        
        <h4>Billing History</h4>
        <table class="table" style="width: 100%; margin-bottom: 20px;">
            <thead>
                <tr>
                    <th style="text-align: left;">Date</th>
                    <th style="text-align: left;">Amount</th>
                    <th style="text-align: left;">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for invoice in invoices %}
                <tr>
                    <td>{{ invoice.issued_date|date:"M d, Y" }}</td>
                    <td>â‚¦{{ invoice.amount }}</td>
                    <td>
                        {% if invoice.status == 'PAID' %}
                            <span style="color: green; font-weight: bold;">
                                &#10003; PAID
                            </span>
                        {% else %}
                            <span style="color: #c62828; font-weight: bold;">
                                &#9888; UNPAID
                            </span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3">No invoices found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        
        <a href="{% url 'doctor_dashboard' %}" class="btn btn-primary">Back to Dashboard</a>
    </div>

    <div style="flex: 1; border-left: 1px solid #ddd; padding-left: 1rem;">
        <h3>GemmaCare Assistant</h3>
        
        <div id="chat-box" style="height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; background: #fafafa; margin-bottom: 10px;">
            <p><em>System: Secure session active. How can I assist with this patient?</em></p>
        </div>
        
        <input type="text" id="user-input" placeholder="Ask about treatments..." style="width: 70%; padding: 8px;">
        <button onclick="sendMessage()" class="btn btn-primary">Ask</button>
    </div>
</div>

<script>
    async function sendMessage() {
        const inputField = document.getElementById('user-input');
        const chatBox = document.getElementById('chat-box');
        const message = inputField.value;
        const patientId = "{{ patient.id }}"; 

        if (!message) return;

        // 1. Show User Message
        chatBox.innerHTML += `<p><strong>You:</strong> ${message}</p>`;
        inputField.value = '';

        // 2. Add Loading Indicator
        const loaderId = "loader-" + Date.now();
        chatBox.innerHTML += `
            <div id="${loaderId}" style="margin: 10px 0;">
                <div class="loader"></div>
                <span class="loading-text">GemmaCare is analyzing...</span>
            </div>`;
        chatBox.scrollTop = chatBox.scrollHeight; // Scroll to bottom

        try {
            // 3. Call Backend
            const response = await fetch('/api/gemmacare/chat/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message, patient_id: patientId })
            });

            const data = await response.json();
            
            // 4. Remove Loader
            document.getElementById(loaderId).remove();

            // 5. Show Response
            if (data.response) {
                chatBox.innerHTML += `<p style="color: #005f73;"><strong>Gemma:</strong> ${data.response}</p>`;
            } else {
                chatBox.innerHTML += `<p style="color: red;"><strong>Error:</strong> ${data.error || 'Unknown error'}</p>`;
            }

        } catch (error) {
            // Remove loader if crash
            const loader = document.getElementById(loaderId);
            if (loader) loader.remove();
            
            console.error(error);
            chatBox.innerHTML += `<p style="color: red;">Connection Failed. Please check server.</p>`;
        }
        
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

<script>
    // Reload the page every 30 seconds to check for new payments
    setTimeout(function(){
       window.location.reload(1);
    }, 30000); 
</script>
{% endblock %}

